<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body style='border:0; margin: 0'>
        <div id='map'></div>
        <div class="searchBar" id = "searchBar">
            <form id="form">
                <input type="text" name="end" class="SearchInput" id="destination" placeholder="Choose ending point" />
                <button class="searchButton" type="submit"></button>
            </form>
        </div>
		<div class="results" id="ResultTableContainer">
            <div class="ResultsTable">
                <table id="nearBikeResultTable" class="StyleTable" cellspacing="0" cellpadding="0">
				</table>
            </div>
		</div>
        <div class="bookInfo" id="InfoTableContainer">
            <div class="MoreInfoTable">
                <table id="InfoTable" class="StyleInfoTable" cellspacing="0" cellpadding="0">
				</table>
            </div>
		</div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
        <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-map.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC"></script>
        <script src="https://www.mapquestapi.com/sdk/leaflet/v2.2/mq-routing.js?key=S8d7L47mdyAG5nHG09dUnSPJjreUVPeC"></script>
        <script   src="./index.cjs"></script>
        <script src="./bundle.js"></script>
        <script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>

        <script>

            //const socket = io("http://10.154.206.37:4000", {
           const socket = io("http://10.21.11.214:4000", {
                withCredentials: true
                });

                
                // creating table for results
                var ResultTable= document.getElementById("nearBikeResultTable");
                var searchBar = document.getElementById("searchBar");
                //create frame on which i have more data about the bike
                var MoreinfoTable= document.getElementById("InfoTable");
                // listener
                socket.on('sendBikesResult', (msg) => {
                        var enc = new TextDecoder("utf-8");
                    ////here
                    var ResultTableContainer= document.getElementById("ResultTableContainer");
                    var InfoTableContainer= document.getElementById("InfoTableContainer");
                    ResultTableContainer.style.visibility='visible';
                    searchBar.style.visibility='hidden';
                    //ResultTableContainer.style.visibility='hidden';


                    //create bike container block for each bike
                    for (var i=0;i<msg.length;i++){

                        // creating a table entry
                        var row = ResultTable.insertRow(i);
                        var cell = row.insertCell(0);
                        //cell.style.height ='1%';

                        // creating image
                        var image= new Image();
                        image.src = 'data:image/png;base64,'+enc.decode(msg[i]['img_src']);
                        image.style.height="100%";
                        image.style.width="30%";

                        // Create bike container
                        var divContainer= document.createElement("div");
                        divContainer.classList.add("grid-container");

                        // create elements
                        var divModel=document.createElement("div");
                        var divPosition=document.createElement("div");
                        var divName=document.createElement("div");
                        var divButton=document.createElement("div");
                        var divPicture=document.createElement("div");

                        //appendText from imcoming message
                        var name = document.createElement('label');
                        name.innerHTML =  msg[i]['name'];
                        divName.appendChild(name);
                        
                        var model = document.createElement('label');
                        model.innerHTML =  msg[i]['model'];
                        divModel.appendChild(model); 
                        
                        var bikePosition = document.createElement('label');
                        bikePosition.innerHTML =  msg[i]['coordinates'];
                        divPosition.appendChild(bikePosition);

                        var bookButton = document.createElement("button");
                        bookButton.classList.add("bookButtonStyle");
                        bookButton.id=i;
                        console.log("before");
                        console.log(msg);
                        bookButton.addEventListener("click",function(){loadBikeSpecificInfo(msg,this.id)}); 
                        
                        bookButton.innerHTML = "Book";
                        divButton.appendChild(bookButton);
                        

                        // style arrangement
                        divModel.classList.add("bikeModel");
                        divPosition.classList.add("bikePosition");
                        divName.classList.add("bikeName");
                        divButton.classList.add("bookButton");
                        divPicture.classList.add("bikePicture");
                        
                        // inserting picture
                        divPicture.appendChild(image);
                        

                        // inserting divs in container
                        divContainer.appendChild(divModel);
                        divContainer.appendChild(divPicture);
                        divContainer.appendChild(divButton);
                        divContainer.appendChild(divPosition);
                        divContainer.appendChild(divName);
                        
                        //insert in result table
                        cell.appendChild(divContainer);

                        

                    }
                });
                //function to load Table for specific info about a certain bike
                function loadBikeSpecificInfo(msg,ID){

                    InfoTableContainer.style.visibility='visible';
                    ResultTableContainer.style.visibility='hidden';
                    var rowInfoTable = InfoTable.insertRow(0);
                    var cellInfoTable = rowInfoTable.insertCell(0);
                    var divContainer= document.createElement("div");
                        divContainer.classList.add("MoreInfoBikeContainer");
                    
                    //variables used to parse the JSON
                    var PriceString = "10";
                    var DescriptionString = "ModelName" + "\n" + "TypeName";
                    var TimeString = "3 minutes";
                    var AddressString = "Kamtjatka 13";




                    //image
                    var enc = new TextDecoder("utf-8");
                    var image= new Image();
                        image.src = 'data:image/png;base64,'+enc.decode(msg[ID]['img_src']);
                        image.style.height="100%";
                        image.style.width="100%";
                    var divPicture=document.createElement("div");
                    divPicture.classList.add("BikePicture_MoreInfo");
                    divPicture.appendChild(image);
                    divContainer.appendChild(divPicture);

                    //name
                    var divName=document.createElement("div");
                    var name = document.createElement('label');
                    name.innerHTML =  msg[ID]['name'];
                    divName.appendChild(name);
                    divName.classList.add("BikeName_MoreInfo");
                    divContainer.appendChild(divName);

                    //price
                    var divPrice = document.createElement("div");
                    var Price = document.createElement('label');
                    Price.innerHTML= PriceString + "DKK";
                    divPrice.appendChild(Price);
                    divPrice.classList.add("BikePrice_MoreInfo");
                    divContainer.appendChild(divPrice);

                    //description

                    var divDescription = document.createElement("div");
                    var description = document.createElement('label');
                    description.innerHTML = DescriptionString;
                    divDescription.appendChild(description);
                    divDescription.classList.add("BikeDescription_MoreInfo");
                    divContainer.appendChild(divDescription);

                    //share button
                    var divShareButton = document.createElement("div");
                    var ShareButton = document.createElement("button");
                    ShareButton.classList.add("ShareButtonStyle"); //TODO: add style in CSS with the image
                    ShareButton.addEventListener("click", function(){shareOutsideApp()}); //TODO: implement function
                    divShareButton.classList.add("ShareButton_MoreInfo");
                    divShareButton.appendChild(ShareButton);
                    divContainer.appendChild(divShareButton);

                    //time
                    var divTime = document.createElement("div");
                    var time = document.createElement('label');
                    time.innerHTML= TimeString;
                    divTime.appendChild(time);
                    divTime.classList.add("Time_MoreInfo");
                    divContainer.appendChild(divTime);

                    //address

                    var divAddress = document.createElement("div");
                    var address = document.createElement('label');
                    address.innerHTML = AddressString;
                    divAddress.appendChild(address);
                    divAddress.classList.add("Address_MoreInfo");
                    divContainer.appendChild(divAddress);

                    //scroll down button
                    
                    var divScrollButton = document.createElement("div");
                    var ScrollButton = document.createElement("button");
                    ScrollButton.innerHTML="Press for more info"
                    ScrollButton.classList.add("ScrollButtonStyle"); //TODO: add style in CSS with the image
                    ScrollButton.addEventListener("click", function(){showMoreInfo()}); //TODO: implement function, maybe some blocks of the grid are hidden?
                    divScrollButton.classList.add("MoreInfoButton_MoreInfo");
                    divScrollButton.appendChild(ScrollButton);
                    divContainer.appendChild(divScrollButton);

                    //book now

                    var divBookButton = document.createElement("div");
                    var BookButton = document.createElement("button");
                    BookButton.innerHTML="Book"
                    BookButton.classList.add("BookButtonStyle"); //TODO: add style in CSS with the image
                    BookButton.addEventListener("click", function(){BookPage()}); //TODO: implement function,
                    divBookButton.appendChild(BookButton);
                    divBookButton.classList.add("BookButton_MoreInfo");
                    divContainer.appendChild(divBookButton);

                    //reserve

                    var divReserveButton = document.createElement("div");
                    var ReserveButton = document.createElement("button");
                    ReserveButton.innerHTML="Reserve for later"
                    ReserveButton.classList.add("ReserveButtonStyle"); //TODO: add style in CSS with the image
                    ReserveButton.addEventListener("click", function(){ReservePage()}); //TODO: implement function, maybe some blocks of the grid are hidden?
                    divReserveButton.classList.add("ReserveButton_MoreInfo");
                    divReserveButton.appendChild(ReserveButton);
                    divContainer.appendChild(divReserveButton);

                        //attach back button
                        //var divButton=document.createElement("div");
                       // var backButton = document.createElement("button");
                       // backButton.classList.add("bookButtonStyle");
                        //backButton.innerHTML="Back"
                        //backButton.addEventListener("click",function(){backToMainTable()}); 
                        //divButton.appendChild(backButton);
                       // divContainer.appendChild(divButton);
                          

                        cellInfoTable.appendChild(divContainer);
                        cellInfoTable.style.height = "100%";
                        cellInfoTable.style.width = "100%";
                }
                //function to come back to main table
                function backToMainTable(){
                    var MoreinfoTable= document.getElementById("InfoTable");
                    InfoTableContainer.style.visibility='hidden';
                    ResultTableContainer.style.visibility='visible';
                    for (var i = 0;i < MoreinfoTable.rows.length;i++){
                        MoreinfoTable.deleteRow(i);
                    }
                }

        </script>
    </body>
</html>